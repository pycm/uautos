var url = require('url');

module.exports = function(req, res, next) {
    var env = req.env || {},
        parsedUrl = url.parse(req.url, true),
        headers = req.headers,
        XHRHeader = headers['x-requested-with'] || null;

    env.isXHR = XHRHeader && XHRHeader.toLowerCase() === 'xmlhttprequest';

    parsedUrl.full = req.url;
    env.url = parsedUrl;

    env.headers = {
        host: headers.host
    };

    env.method = req.method;

    env.params = req.params;

    env.query = req.query;

    env.post = req.body;

    env.files = req.files;

    env.flash = function() {
        return req.flash ? req.flash.apply(req, arguments) : false;
    };

    env.clientIP = (headers && (headers['x-forwarded-for'] || headers['x-host'])) || "127.0.0.1";

    req.env = env;

    next();
};